import streamlit as st
import re

# ---------------------------------------------------------
# 1. ìƒí•œë¡  ì²˜ë°© DB (ìë£Œ ê·¼ê±° / í´ë¦° ë°ì´í„°)
# ---------------------------------------------------------
FORMULA_DB = [
    # [ë°±í˜¸ê°€ì¸ì‚¼íƒ• - ì—´ê¶/ì§„ì•¡ë¶€ì¡±]
    {
        "name": "ë°±í˜¸ê°€ì¸ì‚¼íƒ•", "type": "ì–‘ëª…ë³‘ (ì¡°ì—´)", 
        "symptoms": ["ì‚¬ì§€ëƒ‰", "êµ¬ê±´", "ê·¹ì‹¬í•œ ê°ˆì¦", "ë¬¼ ë§ì´ ë§ˆì‹¬", "ë•€ì´ ë‚¨", "í”¼ë¶€ ì—´ê°", "ë§¥í™ëŒ€", "ì„¤íƒœ í™©", "ì—¬ë¦„ì²  ì‹ìš•ë¶€ì§„"],
        "rx": "ì„ê³  32g, ì§€ëª¨ 12g, ê°ì´ˆ 4g, ê°±ë¯¸ 12g, ì¸ì‚¼ 6g",
        "info": "ì†ë°œì´ ì°¨ë”ë¼ë„ ì…ì´ ë§ˆë¥´ê³  ê°ˆì¦ì´ ì‹¬í•˜ë©´ ì‚¬ìš© (ì—´ê¶). í‰ë¶€ í¬ì•ˆ/ê±°ì•ˆ ë¬´ê´€."
    },
    {
        "name": "ë°±í˜¸íƒ•", "type": "ì–‘ëª…ë³‘", 
        "symptoms": ["ê°ˆì¦", "ë•€ì´ ë‚¨", "ì „ì‹  ì—´ê°", "ë§¥í™œì‚­", "ì„¤íƒœ í™©", "ë¶ˆë©´", "ì „ì‹ í•œ"],
        "rx": "ì„ê³  32g, ì§€ëª¨ 12g, ê°ì´ˆ 4g, ê°±ë¯¸ 12g",
        "info": "ê¸°ë¶„(æ°£åˆ†)ì˜ ì—´ì´ ì„±í•¨. ì¸ì‚¼íƒ•ì¦(ì§„ì•¡ë¶€ì¡±)ë³´ë‹¤ëŠ” ëœí•¨"
    },

    # [ì†Œì‹œí˜¸íƒ• ê³„ì—´]
    {
        "name": "ì†Œì‹œí˜¸íƒ•", "type": "ì†Œì–‘ë³‘", 
        "symptoms": ["í‰í˜‘ê³ ë§Œ(ì¤‘)", "ì…ì´ ì”€", "êµ¬ê±´", "ëª© ë§ˆë¦„", "ì–´ì§€ëŸ¬ì›€", "ì‹ìš•ì €í•˜", "í•œì—´ì™•ë˜", "ë§¥í˜„", "êµ¬ì—­ì§ˆ"],
        "rx": "ì‹œí˜¸ 12g, í™©ê¸ˆ 8g, ì¸ì‚¼ 4g, ë°˜í•˜ 8g, ê°ì´ˆ 4g, ìƒê°• 4g, ëŒ€ì¡° 4g",
        "info": "í‰í˜‘ê³ ë§Œ(ì˜†êµ¬ë¦¬ ê·¸ë“)ì´ í•µì‹¬. ë°˜í‘œë°˜ë¦¬ì¦"
    },
    {
        "name": "ì‹œí˜¸ê³„ì§€íƒ•", "type": "íƒœì–‘ì†Œì–‘í•©ë³‘", 
        "symptoms": ["í‰í˜‘ê³ ë§Œ(ì¤‘)", "ì˜¤í•œ", "ë°œì—´", "ê´€ì ˆí†µ", "ì‹ìš•ì €í•˜", "ì…ì´ ì”€", "ë§¥ë¶€í˜„"],
        "rx": "ì‹œí˜¸ 10g, í™©ê¸ˆ 6g, ì¸ì‚¼ 4g, ë°˜í•˜ 6g, ê³„ì§€ 4g, ì‘ì•½ 4g, ìƒê°• 4g, ëŒ€ì¡° 4g, ê°ì´ˆ 3g",
        "info": "ì†Œì‹œí˜¸íƒ•ì¦ì— ê°ê¸° ê¸°ìš´(í‘œì¦)ê³¼ ê´€ì ˆí†µì´ ë‚¨ì•„ìˆìŒ"
    },
    {
        "name": "ëŒ€ì‹œí˜¸íƒ•", "type": "ì†Œì–‘ì–‘ëª…", 
        "symptoms": ["í‰í˜‘ê³ ë§Œ(ê°•)", "ë³€ë¹„", "ëª…ì¹˜ í†µì¦", "êµ¬í† ", "ë§¥í˜„", "ë³µë¶€íƒ„ë ¥ ê°•", "ì‹¬í•˜ì§€ê²°"],
        "rx": "ì‹œí˜¸ 12g, í™©ê¸ˆ 8g, ì‘ì•½ 8g, ëŒ€í™© 6g, ì§€ì‹¤ 8g, ë°˜í•˜ 8g, ìƒê°• 8g, ëŒ€ì¡° 6g",
        "info": "ì†Œì‹œí˜¸ì¦ì— ë³€ë¹„ì™€ ë³µí†µ(ì‹¤ì¦)ì´ ê²¹ì¹¨"
    },

    # [ìƒì—´í•˜ëƒ‰/í•œì—´ì°©ì¡]
    {
        "name": "ê±´ê°•í™©ê¸ˆí™©ë ¨ì¸ì‚¼íƒ•", "type": "íƒœìŒ/ê¶ìŒ", 
        "symptoms": ["ìƒì—´í•˜ëƒ‰", "ì–¼êµ´ í™”ëˆê±°ë¦¼", "ë°œì´ ì‹œë¦¼", "êµ¬í† ", "ì„¤ì‚¬", "ì‹ìš•ë¶€ì§„", "ì„¤íƒœ í™©"],
        "rx": "ê±´ê°• 6g, í™©ê¸ˆ 6g, í™©ë ¨ 6g, ì¸ì‚¼ 6g",
        "info": "ìƒì²´ëŠ” ì—´ì´ ë‚˜ê³  í•˜ì²´ëŠ” ì°¨ê°€ì›€"
    },
    {
        "name": "ì˜¤ë§¤í™˜", "type": "ê¶ìŒë³‘", 
        "symptoms": ["ìƒì—´í•˜ëƒ‰", "ê°€ìŠ´ ë‹µë‹µ", "ë°°ê°€ ì°¨ê°€ì›€", "êµ¬ì—­ì§ˆ", "ì‚¬ì§€ëƒ‰", "ì„¤ì‚¬", "ê°ˆì¦"],
        "rx": "ì˜¤ë§¤ 30g, ì„¸ì‹  6g, ê±´ê°• 10g, í™©ë ¨ 16g, ë‹¹ê·€ 4g, ë¶€ì 6g, ì´‰ì´ˆ 4g, ê³„ì§€ 6g, ì¸ì‚¼ 6g, í™©ë°± 6g",
        "info": "í•œì—´ì´ ë’¤ì„ì—¬ ìœ—ë°°ëŠ” ëœ¨ê²ê³  ì•„ë«ë°°ëŠ” ì°¨ê°€ì›€"
    },

    # [íƒœì–‘ë³‘/ê°ê¸°]
    {
        "name": "ê³„ì§€íƒ•", "type": "íƒœì–‘ë³‘ (í—ˆì¦)", 
        "symptoms": ["ì˜¤í•œ", "ë°œì—´", "ë•€ì´ ë‚¨", "ì‹ìš•ì €í•˜", "ë‘í†µ", "ì˜¤í’", "ë§¥ë¶€", "ë§¥ì™„", "ìƒì¶©ê°", "í‰ë¶€í¬ì•ˆ"],
        "rx": "ê³„ì§€ 6g, ì‘ì•½ 6g, ìƒê°• 6g, ëŒ€ì¡° 6g, ê°ì´ˆ 4g",
        "info": "ê¸°ìš´ì´ ì—†ê³  ë•€ì´ ì €ì ˆë¡œ ë‚˜ëŠ” ê°ê¸°"
    },
    {
        "name": "ë§ˆí™©íƒ•", "type": "íƒœì–‘ë³‘ (ì‹¤ì¦)", 
        "symptoms": ["ì˜¤í•œ", "ë°œì—´", "ë•€ì´ ì•ˆ ë‚¨", "ëª¸ì´ ì‘¤ì‹¬", "ê´€ì ˆí†µ", "ìˆ¨ì°¸", "ë§¥ë¶€", "ë§¥ê¸´", "ê±°ì•ˆ(ê°•)"],
        "rx": "ë§ˆí™© 8g, ê³„ì§€ 6g, í–‰ì¸ 6g, ê°ì´ˆ 4g",
        "info": "ë•€ì´ ì—†ê³  ë¼ˆë§ˆë””ê°€ ì‘¤ì‹œëŠ” ëª¸ì‚´"
    },
    {
        "name": "ê°ˆê·¼íƒ•", "type": "íƒœì–‘ì–‘ëª…", 
        "symptoms": ["ë’·ëª© ë»£ë»£í•¨(í•­ê°•)", "ì„¤ì‚¬", "ì˜¤í•œ", "ë§¥ë¶€", "ë§¥ê¸´", "ê±°ì•ˆ(ì¤‘)", "í›„ì¤‘"],
        "rx": "ê°ˆê·¼ 8g, ë§ˆí™© 6g, ê³„ì§€ 4g, ì‘ì•½ 4g, ìƒê°• 4g, ëŒ€ì¡° 4g, ê°ì´ˆ 4g",
        "info": "ë’·ëª©ê³¼ ë“±ì¤„ê¸°ê°€ ë»£ë»£í•¨"
    },
    {
        "name": "ëŒ€ì²­ë£¡íƒ•", "type": "íƒœì–‘ë³‘ (í‘œì‹¤ë¦¬ì—´)", 
        "symptoms": ["ë°œì—´", "ë•€ì´ ì•ˆ ë‚¨", "ê°€ìŠ´ ë‹µë‹µ", "ê°ˆì¦", "ì§œì¦", "ë§¥ë¶€", "ë§¥ê¸´", "í‰ë¶€ê±°ì•ˆ(ë³´í†µ)"],
        "rx": "ë§ˆí™© 12g, ì„ê³  24g, ê³„ì§€ 6g, ê°ì´ˆ 4g, ìƒê°• 6g, ëŒ€ì¡° 6g, í–‰ì¸ 6g",
        "info": "ê²‰ì€ ì°¨ê³  ì†ì€ ëœ¨ê±°ì›Œ ë‹µë‹µí•¨. ì„ê³  24g"
    },
    
    # [ì†Œí™”ê¸°/ë¹„ì¦]
    {
        "name": "ë°˜í•˜ì‚¬ì‹¬íƒ•", "type": "ì†Œì–‘ë³‘ (ë¹„ì¦)", 
        "symptoms": ["ì‹¬í•˜ë¹„", "ëª…ì¹˜ ë‹µë‹µ", "êµ¬ì—­ì§ˆ", "ì†ì“°ë¦¼", "ë°°ì—ì„œ ë¬¼ì†Œë¦¬", "ì„¤ì‚¬", "ì¥ëª…"],
        "rx": "ë°˜í•˜ 12g, í™©ê¸ˆ 6g, ì¸ì‚¼ 6g, ê°ì´ˆ 6g, ê±´ê°• 6g, ëŒ€ì¡° 6g, í™©ë ¨ 2g",
        "info": "ëª…ì¹˜ ë°‘ì´ ê·¸ë“í•˜ì§€ë§Œ ëˆ„ë¥´ë©´ ì•„í”„ì§€ ì•ŠìŒ"
    },
    {
        "name": "ìƒê°•ì‚¬ì‹¬íƒ•", "type": "ì†Œì–‘ë³‘", 
        "symptoms": ["ì¥ëª…", "íŠ¸ë¦¼", "êµ¬ì—­ê°", "ì‹¬í•˜ë¹„", "ì„¤ì‚¬"],
        "rx": "ìƒê°• 16g, ë°˜í•˜ 12g, í™©ê¸ˆ 6g, ì¸ì‚¼ 6g, ê°ì´ˆ 6g, ê±´ê°• 6g, ëŒ€ì¡° 6g, í™©ë ¨ 2g",
        "info": "ë¬¼ì†Œë¦¬ì™€ íŠ¸ë¦¼ì´ ì‹¬í•¨"
    },
    {
        "name": "í™©ê¸ˆíƒ•", "type": "ì†Œì–‘/íƒœì–‘", 
        "symptoms": ["í›„ì¤‘", "ì„¤ì‚¬", "ë³µí†µ", "í•˜ë¦¬", "ë°œì—´", "êµ¬í† "],
        "rx": "í™©ê¸ˆ 12g, ì‘ì•½ 8g, ê°ì´ˆ 4g, ëŒ€ì¡° 4g",
        "info": "ì„¤ì‚¬ë¥¼ í•˜ë©´ì„œ ë’¤ê°€ ë¬µì§í•œ ì´ì§ˆ ì¦ìƒ"
    },

    # [ì–‘ëª…ë³‘]
    {
        "name": "ì¡°ìœ„ìŠ¹ê¸°íƒ•", "type": "ì–‘ëª…ë³‘", 
        "symptoms": ["ë³€ë¹„", "ë°°ê°€ ë¹µë¹µí•¨", "ë°œì—´", "ë§¥í™œ", "ë§¥ì‹¤", "ê±°ì•ˆ(ê°•)", "ì„¤íƒœ í™©ì¡°"],
        "rx": "ë§ì´ˆ 16g, ëŒ€í™© 8g, ê°ì´ˆ 4g",
        "info": "ëŒ€ë³€ì´ êµ³ê³  ë°°ê°€ ë¹µë¹µí•¨"
    },

    # [ìŒë³‘/í—ˆí•œ]
    {
        "name": "ì´ì¤‘íƒ•", "type": "íƒœìŒë³‘", 
        "symptoms": ["ë°°ê°€ ì°¨ê°€ì›€", "ì„¤ì‚¬", "êµ¬í† ", "ì‹ìš•ë¶€ì§„", "ë§¥ì¹¨ì§€", "ë¹ˆí˜ˆ", "ë³µë¶€ ë¬´ë ¥", "í‰ë¶€í¬ì•ˆ"],
        "rx": "ì¸ì‚¼ 6g, ë°±ì¶œ 6g, ê±´ê°• 6g, ê°ì´ˆ 6g",
        "info": "ë°°ë¥¼ ë”°ëœ»í•˜ê²Œ ë°ì›Œì£¼ëŠ” ì²˜ë°©. í¬ì•ˆ"
    },
    {
        "name": "ì§„ë¬´íƒ•", "type": "ì†ŒìŒë³‘", 
        "symptoms": ["ì–´ì§€ëŸ¬ì›€", "ëª¸ì´ ë¬´ê±°ì›€", "ì„¤ì‚¬", "ë°°ê°€ ì•„í””", "ëª¸ì´ ë–¨ë¦¼", "ì‚¬ì§€ëƒ‰", "ìˆ˜ì¡±ëƒ‰ì¦", "ë§¥ì¹¨"],
        "rx": "ë³µë ¹ 6g, ì‘ì•½ 6g, ìƒê°• 6g, ë°±ì¶œ 4g, ë¶€ì 1g",
        "info": "ì–‘ê¸° ë¶€ì¡±ìœ¼ë¡œ ë¬¼ì„ ëª» ëŒë¦¼. ë¶€ì 1g"
    },
    {
        "name": "ì‚¬ì—­íƒ•", "type": "ì†ŒìŒë³‘", 
        "symptoms": ["ì‚¬ì§€ëƒ‰", "ì†ë°œì´ ë§¤ìš° ì°¸", "ì„¤ì‚¬", "ë§¥ë¯¸ì„¸", "ì¡¸ë¦¼", "ë³µë¶€íƒ„ë ¥ ìµœí•˜", "í‰ë¶€í¬ì•ˆ"],
        "rx": "ë¶€ì 10g, ê±´ê°• 6g, ê°ì´ˆ 6g",
        "info": "ì–‘ê¸°ê°€ ë‹¤ ë¹ ì ¸ë‚˜ê°€ëŠ” ìœ„ê¸‰í•œ ìƒíƒœ. í¬ì•ˆ"
    },
    {
        "name": "ì˜¤ìˆ˜ìœ íƒ•", "type": "ê¶ìŒë³‘", 
        "symptoms": ["ë‘í†µ(ì •ìˆ˜ë¦¬)", "êµ¬ì—­ì§ˆ", "ì‚¬ì§€ëƒ‰", "ì†ë°œì´ ì°¸", "ê°€ìŠ´ ë‹µë‹µ", "ë§¥í˜„", "í‰ë¶€í¬ì•ˆ"],
        "rx": "ì˜¤ìˆ˜ìœ  6g, ìƒê°• 12g, ì¸ì‚¼ 6g, ëŒ€ì¡° 6g",
        "info": "ë¨¸ë¦¬ê°€ ê¹¨ì§ˆ ë“¯ ì•„í”„ê³  í† í•  ê²ƒ ê°™ìŒ"
    },

    # [ìˆ˜ê¸°/ê¸°íƒ€]
    {
        "name": "ì˜¤ë ¹ì‚°", "type": "ìˆ˜ê¸°ë³‘", 
        "symptoms": ["ì†Œë³€ë¶ˆë¦¬", "êµ¬ê±´", "ëª© ë§ˆë¦„", "ë§¥ë¶€", "ë¬¼ì„¤ì‚¬", "êµ¬í† ", "ë¶€ì¢…"],
        "rx": "íƒì‚¬ 10g, ì €ë ¹ 6g, ë°±ì¶œ 6g, ë³µë ¹ 6g, ê³„ì§€ 4g",
        "info": "ëª© ë§ˆë¥¸ë° ì†Œë³€ì´ ì•ˆ ë‚˜ì˜´"
    },
    {
        "name": "ìê°ì´ˆíƒ•", "type": "ìŒí˜ˆí—ˆ", 
        "symptoms": ["ê°€ìŠ´ ë‘ê·¼ê±°ë¦¼", "ë§¥ê²°ëŒ€", "ìˆ¨ì°¸", "êµ¬ê±´", "ë¹ˆí˜ˆ", "í—ˆë¡œ"],
        "rx": "ê°ì´ˆ 8g, ìƒê°• 6g, ì¸ì‚¼ 4g, ê±´ì§€í™© 8g, ê³„ì§€ 6g, ì•„êµ 4g, ë§¥ë¬¸ë™ 10g, ë§ˆìì¸ 8g, ëŒ€ì¡° 10g",
        "info": "ë§¥ì´ ëšëš ëŠê¸°ëŠ” ë¶€ì •ë§¥"
    },
    {
        "name": "í™©ë ¨ì•„êµíƒ•", "type": "ì†ŒìŒë³‘", 
        "symptoms": ["ë¶ˆë©´ì¦(ì‹¬í•¨)", "í‰ë¶€ê±°ì•ˆ(ì‹¬í•¨)", "ì‹¬ì¥í™”", "ê°€ìŠ´ ë‘ê·¼ê±°ë¦¼", "í˜€ê°€ ë¶‰ìŒ", "ì„¤íƒœ í™©"],
        "rx": "í™©ë ¨ 4g, í™©ê¸ˆ 4g, ì‘ì•½ 4g, ì•„êµ 4g, ê³„ë€ë…¸ë¥¸ì 2ê°œ",
        "info": "ê°€ìŠ´ì´ ë‹µë‹µí•˜ê³  ì ì„ ëª» ì "
    },
    {
        "name": "ë‹¹ê·€ì‘ì•½ì‚°", "type": "ë¶€ì¸ê³¼", 
        "symptoms": ["ìƒë¦¬í†µ", "ì–´ì§€ëŸ¬ì›€", "ë¶€ì¢…", "ë¹ˆí˜ˆ", "ë°°ê°€ ì•„í””", "í•˜ë³µë¶€ ëƒ‰ì¦", "ë§¥ì„¸ì•½", "í‰ë¶€í¬ì•ˆ"],
        "rx": "ì‘ì•½ 12g, ë³µë ¹ 8g, íƒì‚¬ 8g, ë‹¹ê·€ 6g, ì²œê¶ 6g, ë°±ì¶œ 6g",
        "info": "í˜ˆí—ˆìˆ˜ë…. ë¹ˆí˜ˆê³¼ ë¶€ì¢… ë™ë°˜"
    },
    {
        "name": "ê³„ì§€ë³µë ¹í™˜", "type": "ë¶€ì¸ê³¼", 
        "symptoms": ["í•˜ë³µë¶€ í†µì¦", "ì œí•˜ê²½ê²°", "ìƒë¦¬í†µ", "ìƒë¦¬í˜ˆ ë©ì–´ë¦¬", "í”¼ë¶€ ê±°ì¹¨", "ê±°ì•ˆ(ì¤‘)", "ë§¥ì‚½"],
        "rx": "ë³µë ¹ 8g, ê³„ì§€ 6g, ëª©ë‹¨í”¼ 6g, ë„ì¸ 6g, ì‘ì•½ 6g",
        "info": "ì•„ë«ë°°ì— ë”±ë”±í•œ ì–´í˜ˆì´ ìˆìŒ"
    },
    {
        "name": "ì†Œê±´ì¤‘íƒ•", "type": "í—ˆë¡œ", 
        "symptoms": ["ë³µí†µ", "í”¼ë¡œ", "ì‹ìš•ë¶€ì§„", "ê°€ìŠ´ ë‘ê·¼ê±°ë¦¼", "ì†ë°œ ì—´ê°", "ë³µì§ê·¼ ê¸´ì¥(í˜„)", "í‰ë¶€í¬ì•ˆ"],
        "rx": "ê³„ì§€ 6g, ì‘ì•½ 12g, ìƒê°• 6g, ëŒ€ì¡° 6g, ê°ì´ˆ 4g, êµì´ 20g",
        "info": "ë³µì§ê·¼ì´ íŒ½íŒ½í•˜ê³  í—ˆì•½í•¨"
    },
    {
        "name": "ì‚¬ì—­ì‚°", "type": "ì†ŒìŒë³‘", 
        "symptoms": ["í‰í˜‘ê³ ë§Œ(ì¤‘)", "ë³µì§ê·¼ ê¸´ì¥(íŒ)", "ì‚¬ì§€ëƒ‰", "ì†ë°œì´ ì°¸", "ë°°ê°€ ì•„í””", "í™”ê°€ ë‚¨", "ì„¤ì‚¬", "ë§¥í˜„"],
        "rx": "ì‹œí˜¸ 6g, ì‘ì•½ 6g, ì§€ì‹¤ 6g, ê°ì´ˆ 6g",
        "info": "ë°° ì „ì²´ê°€ ë„ë¹¤ì§€ì²˜ëŸ¼ íŒ½íŒ½í•¨"
    }
]

# ---------------------------------------------------------
# 2. ì•½ì¬ í†µí•© ê³„ì‚° í•¨ìˆ˜ (ìµœëŒ€ê°’ ê¸°ì¤€ í•©ë°© - ì„ ìƒë‹˜ ìš”ì²­ ë°˜ì˜)
# ---------------------------------------------------------
def merge_ingredients(formulas, multiplier=1.0):
    merged = {}
    for formula in formulas:
        items = formula['rx'].split(',')
        for item in items:
            item = item.strip()
            match = re.search(r"(\D+)\s*(\d+)g?", item)
            if match:
                name = match.group(1).strip()
                try:
                    weight = float(match.group(2))
                except:
                    weight = 0.0
                
                final_weight = weight * multiplier
                # ì‚¬ì‚¬ì˜¤ì… (ì •ìˆ˜ ì²˜ë¦¬)
                final_weight_int = int(final_weight + 0.5)
                
                # [ìˆ˜ì •ëœ ë¡œì§] í•©ì‚°í•˜ì§€ ì•Šê³ , ë” í° ìš©ëŸ‰ì„ ë”°ë¦„ (Max Value)
                if name in merged:
                    merged[name] = max(merged[name], final_weight_int)
                else:
                    merged[name] = final_weight_int
            else:
                if item not in merged:
                    merged[item] = "ì ë‹¹ëŸ‰"

    # ìš©ëŸ‰ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬
    sorted_ingredients = sorted(merged.items(), key=lambda x: x[1] if isinstance(x[1], int) else 0, reverse=True)
    return sorted_ingredients

# ---------------------------------------------------------
# 3. ì§„ë‹¨ ì—”ì§„
# ---------------------------------------------------------
def calculate_candidates(selected_symptoms):
    results = []
    for formula in FORMULA_DB:
        score = 0
        matched = []
        for symptom in formula['symptoms']:
            for user_sym in selected_symptoms:
                if user_sym.split('(')[0] in symptom or symptom.split('(')[0] in user_sym:
                    score += 10
                    matched.append(symptom)
                    break
        
        # [ì •ë°€ ê°€ì¤‘ì¹˜]
        if "í‰ë¶€ê±°ì•ˆ(ì‹¬í•¨)" in selected_symptoms and formula['name'] == "í™©ë ¨ì•„êµíƒ•": score += 20
        if "í‰ë¶€ê±°ì•ˆ(ë³´í†µ)" in selected_symptoms and formula['name'] == "ì¹˜ìì‹œíƒ•": score += 20
        # í¬ì•ˆ ê°€ì¤‘ì¹˜ (í—ˆì¦ ì²˜ë°©)
        if "í‰ë¶€í¬ì•ˆ" in selected_symptoms and formula['name'] in ["ì´ì¤‘íƒ•(ì¸ì‚¼íƒ•)", "ì‚¬ì—­íƒ•", "ì†Œê±´ì¤‘íƒ•", "ì˜¤ìˆ˜ìœ íƒ•", "ë‹¹ê·€ì‘ì•½ì‚°"]: score += 20
        
        if "ì œí•˜ê²½ê²°" in selected_symptoms and formula['name'] == "ê³„ì§€ë³µë ¹í™˜": score += 20
        if "ë³µì§ê·¼ ê¸´ì¥(í˜„)" in selected_symptoms and formula['name'] == "ì†Œê±´ì¤‘íƒ•": score += 20
        if "ë³µì§ê·¼ ê¸´ì¥(íŒ)" in selected_symptoms and formula['name'] == "ì‚¬ì—­ì‚°": score += 20
        if "ìƒì—´í•˜ëƒ‰" in selected_symptoms and formula['name'] in ["ê±´ê°•í™©ê¸ˆí™©ë ¨ì¸ì‚¼íƒ•", "ì˜¤ë§¤í™˜"]: score += 30
        if "í›„ì¤‘" in selected_symptoms and formula['name'] == "í™©ê¸ˆíƒ•": score += 20
        
        # íŠ¹ìˆ˜ ê°€ì¤‘ì¹˜
        if "í‰í˜‘ê³ ë§Œ" in str(selected_symptoms) and formula['name'] == "ì†Œì‹œí˜¸íƒ•": score += 20
        if formula['name'] == "ë°±í˜¸ê°€ì¸ì‚¼íƒ•" and "ì‚¬ì§€ëƒ‰" in selected_symptoms and "êµ¬ê±´" in selected_symptoms: score += 50

        if score > 0:
            results.append({
                "name": formula['name'], "score": score,
                "matched": list(set(matched)), "rx": formula['rx'], "info": formula['info']
            })
    
    results.sort(key=lambda x: x['score'], reverse=True)
    return results

# ---------------------------------------------------------
# 4. ë©”ì¸ í™”ë©´
# ---------------------------------------------------------
def main():
    st.set_page_config(page_title="ìƒí•œë¡  í•©ë°© ì‹œìŠ¤í…œ", layout="wide")
    st.title("ğŸ©º ìƒí•œë¡  ì •ë°€ ì§„ë‹¨ & ì„ íƒí˜• í•©ë°©ê¸°")
    
    # [ì„¹ì…˜ 1] ì •ë°€ ë³µì§„
    st.header("1ï¸âƒ£ ì •ë°€ ë³µì§„ (Physical Exam)")
    col1, col2, col3 = st.columns(3)
    
    selected_inputs = []
    
    with col1:
        st.subheader("â‘  í‰ë¶€/ëª…ì¹˜ ë°˜ì‘")
        chest_reaction = st.radio(
            "ê°€ìŠ´/ëª…ì¹˜ë¥¼ ëˆŒë €ì„ ë•Œ ë°˜ì‘",
            ["í•´ë‹¹ ì—†ìŒ", "í¬ì•ˆ (ëˆ„ë¥´ë©´ ì‹œì›/í¸ì•ˆí•¨)", "ê±°ì•ˆ (ëˆ„ë¥´ë©´ ë‹µë‹µ/ì•„í””)"],
            horizontal=True
        )
        if "í¬ì•ˆ" in chest_reaction:
            selected_inputs.append("í‰ë¶€í¬ì•ˆ")
        elif "ê±°ì•ˆ" in chest_reaction:
            geoan_level = st.select_slider("ê±°ì•ˆ(ë‹µë‹µí•¨) ê°•ë„", ["ì•½ê°„", "ë³´í†µ", "ë§ì´", "ì‹¬í•¨(í„°ì§ˆë“¯)"], value="ë³´í†µ")
            if "ì‹¬í•¨" in geoan_level: 
                selected_inputs.append("í‰ë¶€ê±°ì•ˆ(ì‹¬í•¨)")
                selected_inputs.append("ì‹¬ì¥í™”")
            elif "ë§ì´" in geoan_level: selected_inputs.append("í‰ë¶€ê±°ì•ˆ(ë§ì´)")
            elif "ë³´í†µ" in geoan_level: selected_inputs.append("í‰ë¶€ê±°ì•ˆ(ë³´í†µ)")
            else: selected_inputs.append("í‰ë¶€ê±°ì•ˆ(ì•½ê°„)")

        if st.checkbox("ìƒì—´í•˜ëƒ‰ (ìœ„ëŠ” ì—´/ì•„ë˜ëŠ” ëƒ‰)"): selected_inputs.append("ìƒì—´í•˜ëƒ‰")

    with col2:
        st.subheader("â‘¡ í‰í˜‘/ë³µì§ê·¼")
        hypo = st.select_slider("í‰í˜‘ê³ ë§Œ (ì €í•­ê°)", ["ì—†ìŒ", "ì•½í•¨", "ì¤‘ê°„", "ê°•í•¨", "ìµœìƒ"], value="ì—†ìŒ")
        if "ê°•í•¨" in hypo: selected_inputs.append("í‰í˜‘ê³ ë§Œ(ê°•)")
        elif "ì¤‘ê°„" in hypo: selected_inputs.append("í‰í˜‘ê³ ë§Œ(ì¤‘)")
        
        rectus = st.selectbox("ë³µì§ê·¼ ìƒíƒœ", ["ì •ìƒ", "ê¸´ì¥ (í˜„ - ê°€ëŠ˜ê³  íŒ½íŒ½)", "ê¸´ì¥ (íŒ - ë„“ê³  ë”±ë”±)", "ì—°ì•½ (ë¬´ë ¥)"])
        if "í˜„" in rectus: selected_inputs.append("ë³µì§ê·¼ ê¸´ì¥(í˜„)")
        elif "íŒ" in rectus: selected_inputs.append("ë³µì§ê·¼ ê¸´ì¥(íŒ)")

    with col3:
        st.subheader("â‘¢ ë³µë¶€ íƒ„ë ¥/ì••í†µ")
        elasticity = st.select_slider("ë³µë¶€ íƒ„ë ¥ë„", ["1(ë¬´ë ¥)", "2(ì•½í•¨)", "3(ë³´í†µ)", "4(íƒ„ë ¥ì¢‹ìŒ)", "5(íŒì/ìµœìƒ)"], value="3(ë³´í†µ)")
        if "1" in elasticity: selected_inputs.append("ë³µë¶€íƒ„ë ¥ ìµœí•˜")
        elif "5" in elasticity: selected_inputs.append("ë³µë¶€íƒ„ë ¥ ìµœìƒ")
        
        if st.checkbox("ì œí•˜ê²½ê²° (ë°°ê¼½ì£¼ë³€ ë”±ë”±)"): selected_inputs.append("ì œí•˜ê²½ê²°")
        if st.checkbox("ì‹¬í•˜ì§€ê²° (ëª…ì¹˜ ë”±ë”±)"): selected_inputs.append("ì‹¬í•˜ì§€ê²°")

    st.markdown("---")
    st.header("2ï¸âƒ£ ìƒì„¸ ì¦ìƒ ì²´í¬")
    
    col_s1, col_s2, col_s3, col_s4, col_s5 = st.columns(5)
    
    with col_s1:
        st.subheader("ë¨¸ë¦¬/êµ¬ê°•/ë§¥")
        pulses = st.multiselect("ë§¥ìƒ", ["ë§¥ë¶€", "ë§¥ì¹¨", "ë§¥í˜„", "ë§¥ê¸´", "ë§¥í™ëŒ€", "ë§¥ì„¸", "ë§¥ê²°ëŒ€", "ë§¥ë¯¸ì„¸", "ë§¥ì™„", "ë§¥í™œì‚­"])
        selected_inputs.extend(pulses)
        checks = ["ë‘í†µ", "ì–´ì§€ëŸ¬ì›€", "ë’·ëª© ë»£ë»£í•¨", "ì…ì´ ì”€", "êµ¬ê±´(ì… ë§ˆë¦„)", "ëª© ë§ˆë¦„", "ê·¹ì‹¬í•œ ê°ˆì¦"]
        for c in checks:
            if st.checkbox(c, key=c): selected_inputs.append(c)
    
    with col_s2:
        st.subheader("ê°€ìŠ´/ì†Œí™”ê¸°")
        checks = ["ëª…ì¹˜ ë‹µë‹µ(ì‹¬í•˜ë¹„)", "ì†ì“°ë¦¼", "êµ¬ì—­ì§ˆ", "ì‹ìš•ì €í•˜", "ì¥ëª…(ë¬¼ì†Œë¦¬)", "ê°€ìŠ¤/íŒ½ë§Œ", "ë³€ë¹„", "ì„¤ì‚¬", "ë°°ê°€ ì°¨ê°€ì›€"]
        for c in checks:
            if st.checkbox(c, key=c): selected_inputs.append(c)

    with col_s3:
        st.subheader("í•œì—´/ì „ì‹ ")
        if st.checkbox("ì‚¬ì§€ëƒ‰ (ì†ë°œ ì „ì²´ ì‹œë¦¼)"): selected_inputs.append("ì‚¬ì§€ëƒ‰")
        checks = ["ì˜¤í•œ", "ë°œì—´", "í•œì—´ì™•ë˜", "ë•€ì´ ë‚¨", "ë•€ì´ ì•ˆ ë‚¨", "ì˜¤í’", "ë¬¼ ë§ì´ ë§ˆì‹¬", "ëª¸ì´ ë¬´ê±°ì›€", "ê¸°ë ¥ì €í•˜"]
        for c in checks:
            if st.checkbox(c, key=c): selected_inputs.append(c)

    with col_s4:
        st.subheader("ë¶€ì¸ê³¼/ê¸°íƒ€")
        checks = ["ìƒë¦¬í†µ", "ìƒë¦¬ë¶ˆìˆœ", "ë¹ˆí˜ˆ", "ë¶€ì¢…", "ì†Œë³€ë¶ˆë¦¬", "ëª¸ì´ ì‘¤ì‹¬", "ìƒì¶©ê°", "ì†ë°œì´ ì°¸"]
        for c in checks:
            if st.checkbox(c, key=c): selected_inputs.append(c)
            
    with col_s5:
        st.subheader("ëŒ€ë³€/ë•€(ìƒì„¸)")
        if st.checkbox("í›„ì¤‘ (ë’¤ê°€ ë¬µì§)"): selected_inputs.append("í›„ì¤‘")
        if st.checkbox("ë‘í•œ (ë¨¸ë¦¬ ë•€)"): selected_inputs.append("ë‘í•œ")
        if st.checkbox("ì „ì‹ í•œ (ì „ì‹  ë•€)"): selected_inputs.append("ì „ì‹ í•œ")
        insomnia = st.selectbox("ë¶ˆë©´ì¦", ["ì—†ìŒ", "ì•½ê°„(ì…ë©´ë‚œ)", "ë³´í†µ(ì¤‘ê°„ê¹¸)", "ì‹¬í•¨(ë°¤ìƒ˜)"])
        if "ì‹¬í•¨" in insomnia: selected_inputs.append("ë¶ˆë©´ì¦(ì‹¬í•¨)")
        elif "ë³´í†µ" in insomnia: selected_inputs.append("ë¶ˆë©´ì¦(ì¤‘)")

    st.markdown("---")

    # [ë¶„ì„ ë‹¨ê³„]
    if selected_inputs:
        candidates = calculate_candidates(selected_inputs)
        
        st.info(f"**ì„ íƒëœ ì¦ìƒ:** {', '.join(selected_inputs)}")
        
        if candidates:
            st.header("3ï¸âƒ£ ì²˜ë°© ì„ íƒ ë° í•©ë°© (Select Formulas)")
            st.caption("ì•„ë˜ ì¶”ì²œ ëª©ë¡ì—ì„œ **í•©ë°©í•˜ê³  ì‹¶ì€ ì²˜ë°©ì„ ì²´í¬**í•˜ì„¸ìš”. (ìƒìœ„ 15ê°œ í‘œì‹œ)")
            
            selected_formulas = []
            
            for res in candidates[:15]:
                # [ìˆ˜ì •] ì²˜ë°© ë‚´ìš©(Rx)ì„ ë¼ë²¨ ì•„ë˜ì— ëª…í™•íˆ í‘œì‹œ
                col_c1, col_c2 = st.columns([0.1, 0.9])
                with col_c1:
                    checked = st.checkbox("", key=res['name'])
                with col_c2:
                    st.write(f"**{res['name']}** (ì ìˆ˜: {res['score']}ì )")
                    st.code(f"{res['rx']}") # ì²˜ë°© ë‚´ìš© ê°•ì¡°
                    st.caption(f"ğŸ’¡ {res['info']} (ì¼ì¹˜: {', '.join(res['matched'])})")
                
                if checked:
                    selected_formulas.append(res)
                st.write("---") # êµ¬ë¶„ì„ 

            if selected_formulas:
                st.header("4ï¸âƒ£ ìµœì¢… í•©ë°© ì²˜ë°©ì „ (Final Recipe)")
                
                # ë°°ìˆ˜ ì¡°ì ˆ
                multiplier = st.select_slider(
                    "ìš©ëŸ‰ ë°°ìˆ˜ (Multiplier)", 
                    options=[0.5, 0.8, 1.0, 1.2, 1.5, 2.0, 3.0], 
                    value=1.0
                )
                
                combined_name = " + ".join([f['name'] for f in selected_formulas])
                st.success(f"### ğŸ¥£ ì„ íƒëœ í•©ë°©: {combined_name}")
                st.info(f"**ì ìš© ë°°ìˆ˜: {multiplier}ë°°** (ìš©ëŸ‰ì´ ë§ì€ ì•½ì¬ ìš°ì„ , ì¤‘ë³µ ì‹œ ìµœëŒ€ê°’ ì ìš©)")
                
                final_ingredients = merge_ingredients(selected_formulas, multiplier)
                
                st.subheader("ğŸ’Š í†µí•© ì•½ì¬ ìš©ëŸ‰ (ë§ì€ ìˆœ)")
                
                col_i1, col_i2, col_i3 = st.columns(3)
                for i, (name, weight) in enumerate(final_ingredients):
                    target_col = [col_i1, col_i2, col_i3][i % 3]
                    with target_col:
                        if isinstance(weight, int):
                            st.error(f"**{name} {weight}g**")
                        else:
                            st.warning(f"**{name}**")
            else:
                st.info("ğŸ‘† ìœ„ ëª©ë¡ì—ì„œ í•©ë°©í•  ì²˜ë°©ì„ ì„ íƒí•˜ë©´ ê³„ì‚° ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤.")

        else:
            st.warning("ì¼ì¹˜í•˜ëŠ” ì²˜ë°©ì´ ì—†ìŠµë‹ˆë‹¤.")
    else:
        st.info("ì¦ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.")

if __name__ == "__main__":
    main()
